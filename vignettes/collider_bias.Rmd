---
title: "Collider bias"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Collider bias}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

An example of using the `ColliderBias()` class and associated functions to investigate the degree of index event (collider) bias in your GWAS progression data. 

```{r setup, eval=T, results="hide", warning=FALSE, message=FALSE}
library(genepi.utils)

gwas_incidence <- generate_random_gwas_data(50000)
gwas_progression <- generate_random_gwas_data(50000)
gwas_progression[, BETA := sample(BETA, replace=TRUE)]

collider_object <- ColliderBias(gwas_incidence, gwas_progression)
```

## Slope-hunter

Run the Slope-hunter algorithm.

```{r run_slopehunter, eval=T}
collider_object <- slopehunter(collider_object, bootstraps=10)
```
Run the SlopeHunter expectation-maximization method to estimate the bias adjustment factor. The algorithm uses model-based clustering and proposes that the distributions of the incidence(GI) and progression (GP) BETAs can be written like so:  

$$
  \binom{\beta_{GI}}{\beta'_{GI}}
  \sim
  \pi_{1}N
  \begin{pmatrix}
  \underline{0},
  \begin{bmatrix}
  \sigma_{I}^{2} & b_{1}\sigma_{I}^{2} \\
  b_1\sigma_{I}^{2} & b_{1}^{2}\sigma_{I}^{2} \\
  \end{bmatrix}
  \end{pmatrix}
  +
  \pi_{2}N
  \begin{pmatrix}
  \underline{0},
  \begin{bmatrix}
  \sigma_{I}^{2} & b_{1}\sigma_{I}^{2} + \sigma_{IP} \\
  b_1\sigma_{I}^{2} + \sigma_{IP} & b_{1}^{2}\sigma_{I}^{2} + \sigma_{P}^{2} + 2b_{1}\sigma_{IP} \\
  \end{bmatrix}
  \end{pmatrix}
  +
  \pi_{3}
  \begin{pmatrix}
  \eta_{0} \\
  N(0, \sigma_{P}^{2})
  \end{pmatrix}
  +
  \pi_{4}
  \begin{pmatrix}
  \eta_{0} \\
  \eta_{0}
  \end{pmatrix}
$$
  
  
* Cluster 1: SNPs that cause incidence but not progression  
* Cluster 2: SNPs that cause incidence and progression  
* Cluster 3: SNPs that cause progression but not incidence  
* Cluster 4: SNPs that cause neither incidence or progression  

The values \eqn{\pi_{1}, \pi_{2}, \pi_{3}, \pi_{4}} are the probabilities that a SNP belongs to the respective clusters.  

The first thing to note is that we can filter out SNPs from cluster 3 and 4 by only including SNPs with a significant association (P-value) with incidence - this is the `ip` parameter. The problem is then reduced to finding two clusters that best fit distributions 1 and 2 of the equation above. The SlopeHunter EM algorithm iteratively determines which SNPs belong to each distribution (probabilistically) and once complete the adjustment factor (slope gradient) can be determined from group 1, i.e. only those SNPs thought to solely cause incidence.  

This function's code is adapted from the SlopeHunter R package and if using this method the SlopeHunter package should be referenced as the original source.


## Plot

Visualise the iterative algorithm

```{r plot_gif, eval=FALSE}
p <- plot_slopehunter_iters(collider_object)

p
```
```{r save_gif, include=FALSE, eval=FALSE}
gganimate::anim_save("figures/slopehunter.gif")
```
```{r show_gif, echo=FALSE, out.width="90%", fig.align='center'}
knitr::include_graphics("figures/slopehunter.gif")
```
