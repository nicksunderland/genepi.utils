<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rationale and key points • genepi.utils</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Rationale and key points">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">genepi.utils</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.31</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/chrpos_to_rsid.html">CHR:POS to RSID mapping</a>
    </li>
    <li>
      <a href="../articles/clumping.html">Clumping</a>
    </li>
    <li>
      <a href="../articles/collider_bias.html">Collider bias</a>
    </li>
    <li>
      <a href="../articles/drug_target_proxy.html">Drug target proxies</a>
    </li>
    <li>
      <a href="../articles/harmonise.html">Harmonising datasets</a>
    </li>
    <li>
      <a href="../articles/ld_matrix.html">LD matrix</a>
    </li>
    <li>
      <a href="../articles/plotting.html">Plotting</a>
    </li>
    <li>
      <a href="../articles/rationale.html">Rationale and key points</a>
    </li>
    <li>
      <a href="../articles/standardise_gwas.html">Standardise GWAS</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Rationale and key points</h1>
            
      

      <div class="hidden name"><code>rationale.Rmd</code></div>

    </div>

    
    
<style>
  body {
    text-align: justify
  }
</style>
<p>The primary motivation for creating this package was to increase my
understanding of the many tools used in the processing of GWAS data and
Mendelian randomization analyses at the start of my PhD. Like many
people new to the field, I found there to be an overwhelming number of
options in many different languages, designed with slightly different
use cases in mind.</p>
<div class="section level2">
<h2 id="roadmap">Roadmap<a class="anchor" aria-label="anchor" href="#roadmap"></a>
</h2>
<p><strong>Phase 1</strong> was aimed at simple GWAS processing:<br>
1. Reading files<br>
2. Field / column name standardiation<br>
3. Quality control and cleaning<br><br></p>
<p><strong>Phase 2</strong> was aimed at common GWAS routines:<br>
4. Clumping<br>
5. Annotating RSIDs<br>
6. Generating LD matrices<br>
7. Finding proxies variants<br><br></p>
<p><strong>Phase 3</strong> was aimed at more specific routines:<br>
8. Calling UVMR &amp; MVMR routines from <code>TwoSampleMR</code> and
<code>Mendelian Randomization</code><br>
9. Index-event bias - calling <code>IndexEvent</code> and MR
routines<br><br></p>
</div>
<div class="section level2">
<h2 id="choice-of-language">Choice of language<a class="anchor" aria-label="anchor" href="#choice-of-language"></a>
</h2>
<p>The most commonly used languages for data analysis are <code>R</code>
and <code>Python</code>, with many command line porgrammes written in
<code>C++</code> and <code>C</code>. For ease of use, familiarity, and
prospect of onoing collaboration I wrote this in <code>R</code>.
<br></p>
<p><img src="figures/programming_languages_icons.jpeg" width="50%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="representation-of-gwas-data">Representation of GWAS data<a class="anchor" aria-label="anchor" href="#representation-of-gwas-data"></a>
</h2>
<p>The next question I had was how to represent GWAS in <code>R</code>.
The obvious choice is a simple vectors or data.frames, but the range of
structures used across common genetic epidemiology packages is wide,
ranging from lists (that can take any data type and often require
separate validation functions - e.g. <code>coloc</code>) to layers of
custom classes that can be difficult to understand and re-use. <br></p>
<p><img src="figures/r_data_structures.png" width="80%" style="display: block; margin: auto;"><br></p>
</div>
<div class="section level2">
<h2 id="gwas-data-specification">GWAS data specification<a class="anchor" aria-label="anchor" href="#gwas-data-specification"></a>
</h2>
<p>The GWAS data we need for the majority of analyses is well defined
but the range of data formats out in the wild is all too often lacking.
Data standardisation continues to be addressed and there exists many
good resources and recommended specifications. <br></p>
<p><img src="figures/gwas_vcf_specification.png" width="60%" style="display: block; margin: auto;"><img src="figures/hayhurst_et_al_2022.png" width="60%" style="display: block; margin: auto;"><br></p>
<p><img src="figures/gwas_field_specification.jpeg" width="100%" style="display: block; margin: auto;"><br></p>
<div class="section level3">
<h3 id="data-type-considerations">Data type considerations<a class="anchor" aria-label="anchor" href="#data-type-considerations"></a>
</h3>
<p>There may be some data type considerations in terms of memory,
especially when dealing with very large GWAS datasets on more standard
machines. With off-the-self computer memory increasesing this is
becoming less of an issue. <br></p>
<p><img src="figures/gwas_types_memory.png" width="80%" style="display: block; margin: auto;"><br></p>
</div>
</div>
<div class="section level2">
<h2 id="s7">S7<a class="anchor" aria-label="anchor" href="#s7"></a>
</h2>
<p>I really wanted an object-orientated approach and after initial
frustrations with the <code>S4</code> and <code>R6</code> class systems
I was made aware of the new <code>S7</code> class system. Being probably
too quick to jump on the latest trend I refactored my initial code into
<code>S7</code>. I liked the <code>S7</code> class system as it has
strongly typed properties and simplifies what can be quite complex
idiosyncrasies in <code>S4</code>. It also has a really nice constructor
and validation process built in.</p>
<div class="section level3">
<h3 id="simple-s7-class">Simple S7 class<a class="anchor" aria-label="anchor" href="#simple-s7-class"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rconsortium/S7/" class="external-link">S7</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define a new class</span></span>
<span><span class="va">CodeClinicSession</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_class.html" class="external-link">new_class</a></span><span class="op">(</span></span>
<span>  name       <span class="op">=</span> <span class="st">"CodeClinicSession"</span>,</span>
<span>  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    presenter <span class="op">=</span> <span class="va">class_character</span>,</span>
<span>    date      <span class="op">=</span> <span class="va">class_Date</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a CodeClinicSession object</span></span>
<span><span class="va">session</span> <span class="op">&lt;-</span> <span class="fu">CodeClinicSession</span><span class="op">(</span><span class="st">"nick"</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2024-07-25"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">session</span></span>
<span><span class="co">#&gt; &lt;CodeClinicSession&gt;</span></span>
<span><span class="co">#&gt;  @ presenter: chr "nick"</span></span>
<span><span class="co">#&gt;  @ date     : Date[1:1], format: "2024-07-25"</span></span>
<span></span>
<span><span class="co"># define a generic print function </span></span>
<span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/method.html" class="external-link">method</a></span><span class="op">(</span><span class="va">print</span>, <span class="va">CodeClinicSession</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"CodeClinicSession\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\tPresenter:"</span>, <span class="va">x</span><span class="op">@</span><span class="va">presenter</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\tDate:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">x</span><span class="op">@</span><span class="va">date</span>, <span class="st">"%d-%m-%Y"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">session</span><span class="op">)</span></span>
<span><span class="co">#&gt; CodeClinicSession</span></span>
<span><span class="co">#&gt;  Presenter: nick </span></span>
<span><span class="co">#&gt;  Date: 25-07-2024</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="s7-property-validation">S7 property validation<a class="anchor" aria-label="anchor" href="#s7-property-validation"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define a more complicated class</span></span>
<span><span class="va">CodeClinicSession</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_class.html" class="external-link">new_class</a></span><span class="op">(</span></span>
<span>  name       <span class="op">=</span> <span class="st">"CodeClinicSession"</span>,</span>
<span>  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    presenter <span class="op">=</span> <span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_property.html" class="external-link">new_property</a></span><span class="op">(</span>class     <span class="op">=</span> <span class="va">class_character</span>, </span>
<span>                             validator <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span> </span>
<span>                               <span class="va">valid_presenters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nick sunderland"</span>, <span class="st">"foo"</span>, <span class="st">"bar"</span><span class="op">)</span></span>
<span>                               <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">valid_presenters</span><span class="op">)</span> <span class="op">{</span></span>
<span>                                 <span class="va">found</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="va">value</span>, <span class="va">valid_presenters</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>                                 <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">found</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>                                   <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">value</span>, <span class="st">"- did you mean presenter"</span>, <span class="va">found</span>, <span class="st">"?"</span><span class="op">)</span><span class="op">)</span></span>
<span>                                 <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>                                   <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span>                                 <span class="op">}</span></span>
<span>                               <span class="op">}</span> </span>
<span>                             <span class="op">}</span><span class="op">)</span>,</span>
<span>    date      <span class="op">=</span> <span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_property.html" class="external-link">new_property</a></span><span class="op">(</span>class   <span class="op">=</span> <span class="va">class_Date</span>, </span>
<span>                             default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a CodeClinicSession object</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu">CodeClinicSession</span><span class="op">(</span><span class="st">"nick"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error : &lt;CodeClinicSession&gt; object properties are invalid:</span></span>
<span><span class="co">#&gt; - @presenter nick - did you mean presenter nick sunderland ?</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu">CodeClinicSession</span><span class="op">(</span><span class="st">"nick sunderland"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; CodeClinicSession</span></span>
<span><span class="co">#&gt;  Presenter: nick sunderland </span></span>
<span><span class="co">#&gt;  Date: 07-10-2024</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="s7-constructor">S7 constructor<a class="anchor" aria-label="anchor" href="#s7-constructor"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define a more complicated class</span></span>
<span><span class="va">CodeClinicSession</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_class.html" class="external-link">new_class</a></span><span class="op">(</span></span>
<span>  name       <span class="op">=</span> <span class="st">"CodeClinicSession"</span>,</span>
<span>  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    presenter <span class="op">=</span> <span class="va">class_character</span>,</span>
<span>    date      <span class="op">=</span> <span class="va">class_Date</span></span>
<span>  <span class="op">)</span>, </span>
<span>  constructor <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">some_text</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># parse some text</span></span>
<span>    <span class="va">valid_presenters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nick sunderland"</span>, <span class="st">"foo"</span>, <span class="st">"bar"</span><span class="op">)</span></span>
<span>    <span class="va">presenter</span> <span class="op">&lt;-</span> <span class="va">valid_presenters</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">valid_presenters</span>, <span class="va">grepl</span>, <span class="va">some_text</span>, ignore.case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">date</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">".*?([0-9]+-[0-9]+-[0-9]+).*"</span>, <span class="st">"\\1"</span>, <span class="va">some_text</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># load the properties</span></span>
<span>    <span class="va">object</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_class.html" class="external-link">new_object</a></span><span class="op">(</span><span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/S7_object.html" class="external-link">S7_object</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                         presenter <span class="op">=</span> <span class="va">presenter</span>, </span>
<span>                         date      <span class="op">=</span> <span class="va">date</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># return the object</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a CodeClinicSession object</span></span>
<span><span class="va">session</span> <span class="op">&lt;-</span> <span class="fu">CodeClinicSession</span><span class="op">(</span><span class="st">"Nick Sunderland presenting on 2024-07-25"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">session</span></span>
<span><span class="co">#&gt; CodeClinicSession</span></span>
<span><span class="co">#&gt;  Presenter: nick sunderland </span></span>
<span><span class="co">#&gt;  Date: 25-07-2024</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="gwas-class">GWAS class<a class="anchor" aria-label="anchor" href="#gwas-class"></a>
</h3>
<p>Putting this all together I created a GWAS class.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">GWAS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_class.html" class="external-link">new_class</a></span><span class="op">(</span></span>
<span>  <span class="co">#==============================</span></span>
<span>  <span class="co"># GWAS class name</span></span>
<span>  <span class="co">#==============================</span></span>
<span>  name    <span class="op">=</span> <span class="st">"GWAS"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"genepi.utils"</span>,</span>
<span></span>
<span>  <span class="co">#==============================</span></span>
<span>  <span class="co"># GWAS class properties</span></span>
<span>  <span class="co">#==============================</span></span>
<span>  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="co">#----------------------------</span></span>
<span>    <span class="co"># column name mapping</span></span>
<span>    <span class="co">#----------------------------</span></span>
<span>    map     <span class="op">=</span> <span class="va">ColumnMap</span>,</span>
<span>    <span class="co">#----------------------------</span></span>
<span>    <span class="co"># qc procedures</span></span>
<span>    <span class="co">#----------------------------</span></span>
<span>    qc      <span class="op">=</span> <span class="va">class_list</span>,</span>
<span>    <span class="co">#----------------------------</span></span>
<span>    <span class="co"># column names / data vectors</span></span>
<span>    <span class="co">#----------------------------</span></span>
<span>    rsid    <span class="op">=</span> <span class="va">class_character</span>,</span>
<span>    chr     <span class="op">=</span> <span class="va">class_character</span>,</span>
<span>    bp      <span class="op">=</span> <span class="va">class_integer</span>,</span>
<span>    ea      <span class="op">=</span> <span class="va">class_character</span>,</span>
<span>    oa      <span class="op">=</span> <span class="va">class_character</span>,</span>
<span>    eaf     <span class="op">=</span> <span class="va">class_numeric</span>,</span>
<span>    beta    <span class="op">=</span> <span class="va">class_numeric</span>,</span>
<span>    se      <span class="op">=</span> <span class="va">class_numeric</span>,</span>
<span>    p       <span class="op">=</span> <span class="va">class_numeric</span>,</span>
<span>    n       <span class="op">=</span> <span class="va">class_integer</span>,</span>
<span>    ncase   <span class="op">=</span> <span class="va">class_integer</span>,</span>
<span>    strand  <span class="op">=</span> <span class="va">class_character</span>,</span>
<span>    imputed <span class="op">=</span> <span class="va">class_logical</span>,</span>
<span>    info    <span class="op">=</span> <span class="va">class_numeric</span>,</span>
<span>    q       <span class="op">=</span> <span class="va">class_numeric</span>,</span>
<span>    q_p     <span class="op">=</span> <span class="va">class_numeric</span>,</span>
<span>    i2      <span class="op">=</span> <span class="va">class_numeric</span>,</span>
<span>    <span class="co">#----------------------------</span></span>
<span>    <span class="co"># correlation matrix</span></span>
<span>    <span class="co">#----------------------------</span></span>
<span>    correlation <span class="op">=</span> <span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_S3_class.html" class="external-link">new_S3_class</a></span><span class="op">(</span><span class="st">'matrix'</span><span class="op">)</span>,</span>
<span>    <span class="co">#----------------------------</span></span>
<span>    <span class="co"># meta data</span></span>
<span>    <span class="co">#----------------------------</span></span>
<span>    trait   <span class="op">=</span> <span class="va">class_character</span>,</span>
<span>    id      <span class="op">=</span> <span class="va">class_character</span>,</span>
<span>    source  <span class="op">=</span> <span class="va">class_character</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  <span class="co">#==============================</span></span>
<span>  <span class="co"># GWAS class constructor func.</span></span>
<span>  <span class="co">#==============================</span></span>
<span>  constructor <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>,</span>
<span>                         <span class="va">map</span>            <span class="op">=</span> <span class="st">"default"</span>,</span>
<span>                         <span class="va">drop</span>           <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                         <span class="va">fill</span>           <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                         <span class="va">fill_rsid</span>      <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                         <span class="va">missing_rsid</span>   <span class="op">=</span> <span class="st">"fill_CHR:BP"</span>,</span>
<span>                         <span class="va">parallel_cores</span> <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                         <span class="va">dbsnp_dir</span>      <span class="op">=</span> <span class="fu">genepi.utils</span><span class="fu">::</span><span class="fu"><a href="../reference/which_dbsnp_directory.html">which_dbsnp_directory</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                         <span class="va">filters</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                           beta_invalid    <span class="op">=</span> <span class="st">"!is.infinite(beta) &amp; abs(beta) &lt; 20"</span>,</span>
<span>                           eaf_invalid     <span class="op">=</span> <span class="st">"eaf &gt; 0 &amp; eaf &lt; 1"</span>,</span>
<span>                           p_invalid       <span class="op">=</span> <span class="st">"!is.infinite(p)"</span>,</span>
<span>                           se_invalid      <span class="op">=</span> <span class="st">"!is.infinite(se)"</span>,</span>
<span>                           alleles_invalid <span class="op">=</span> <span class="st">"!is.na(ea) &amp; !is.na(oa)"</span>,</span>
<span>                           chr_missing     <span class="op">=</span> <span class="st">"!is.na(chr)"</span>,</span>
<span>                           bp_missing      <span class="op">=</span> <span class="st">"!is.na(bp)"</span>,</span>
<span>                           beta_missing    <span class="op">=</span> <span class="st">"!is.na(beta)"</span>,</span>
<span>                           se_missing      <span class="op">=</span> <span class="st">"!is.na(se)"</span>,</span>
<span>                           p_missing       <span class="op">=</span> <span class="st">"!is.na(p)"</span>,</span>
<span>                           eaf_missing     <span class="op">=</span> <span class="st">"!is.na(eaf)"</span><span class="op">)</span>,</span>
<span>                         <span class="va">reference</span>      <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                         <span class="va">ref_map</span>        <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                         <span class="va">verbose</span>        <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                         <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">verbose</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Loading GWAS ..."</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># parse the map</span></span>
<span>    <span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ColumnMap.html">ColumnMap</a></span><span class="op">(</span><span class="va">map</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># as data table</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">dat</span>, <span class="st">'data.frame'</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">dat</span>, <span class="st">'data.table'</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># load (either from file or data.frame)</span></span>
<span>    <span class="va">gwas</span> <span class="op">&lt;-</span> <span class="fu">load_gwas</span><span class="op">(</span><span class="va">dat</span>, map<span class="op">=</span><span class="va">map</span>, drop<span class="op">=</span><span class="va">drop</span>, fill<span class="op">=</span><span class="va">fill</span>, verbose<span class="op">=</span><span class="va">verbose</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># ensure correct type</span></span>
<span>    <span class="va">gwas</span> <span class="op">&lt;-</span> <span class="fu">type_columns</span><span class="op">(</span><span class="va">gwas</span>, map<span class="op">=</span><span class="va">map</span>, verbose<span class="op">=</span><span class="va">verbose</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># standardise columns</span></span>
<span>    <span class="va">gwas</span> <span class="op">&lt;-</span> <span class="fu">standardise_columns</span><span class="op">(</span><span class="va">gwas</span>, verbose<span class="op">=</span><span class="va">verbose</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># standardise alleles</span></span>
<span>    <span class="va">gwas</span> <span class="op">&lt;-</span> <span class="fu">standardise_alleles</span><span class="op">(</span><span class="va">gwas</span>, verbose<span class="op">=</span><span class="va">verbose</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># apply filters</span></span>
<span>    <span class="va">g</span>    <span class="op">&lt;-</span> <span class="fu">apply_filters</span><span class="op">(</span><span class="va">gwas</span>, filters<span class="op">=</span><span class="va">filters</span>, verbose<span class="op">=</span><span class="va">verbose</span><span class="op">)</span></span>
<span>    <span class="va">gwas</span> <span class="op">&lt;-</span> <span class="va">g</span><span class="op">$</span><span class="va">gwas</span></span>
<span>    <span class="va">qc</span>   <span class="op">&lt;-</span> <span class="va">g</span><span class="op">$</span><span class="va">qc</span></span>
<span></span>
<span>    <span class="co"># add or reformat id/rsid</span></span>
<span>    <span class="va">gwas</span> <span class="op">&lt;-</span> <span class="fu">populate_rsid</span><span class="op">(</span><span class="va">gwas</span>, fill_rsid<span class="op">=</span><span class="va">fill_rsid</span>, missing_rsid<span class="op">=</span><span class="va">missing_rsid</span>, parallel_cores<span class="op">=</span><span class="va">parallel_cores</span>, dbsnp_dir<span class="op">=</span><span class="va">dbsnp_dir</span>, verbose<span class="op">=</span><span class="va">verbose</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># harmonise to reference</span></span>
<span>    <span class="va">g</span> <span class="op">&lt;-</span> <span class="fu">harmonise_reference</span><span class="op">(</span><span class="va">gwas</span>, reference<span class="op">=</span><span class="va">reference</span>, ref_map<span class="op">=</span><span class="va">ref_map</span>, qc<span class="op">=</span><span class="va">qc</span>, verbose<span class="op">=</span><span class="va">verbose</span><span class="op">)</span></span>
<span>    <span class="va">gwas</span> <span class="op">&lt;-</span> <span class="va">g</span><span class="op">$</span><span class="va">gwas</span></span>
<span>    <span class="va">qc</span>   <span class="op">&lt;-</span> <span class="va">g</span><span class="op">$</span><span class="va">qc</span></span>
<span></span>
<span>    <span class="co"># other changes</span></span>
<span>    <span class="va">gwas</span><span class="op">[</span><span class="va">p</span><span class="op">==</span><span class="fl">0</span>, <span class="va">p</span> <span class="op">:=</span> <span class="va">.Machine</span><span class="op">$</span><span class="va">double.xmin</span><span class="op">]</span></span>
<span></span>
<span>    <span class="co"># group together as a big list; add the other properties that may have been passed</span></span>
<span>    <span class="va">props</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gwas</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>map<span class="op">=</span><span class="va">map</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># don't need to save all of repetitive columns</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">"n"</span>      <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span>                                   <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">n</span>       <span class="op">&lt;-</span> <span class="cn">NA_integer_</span>         <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">"ncase"</span>  <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span>                                   <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">ncase</span>   <span class="op">&lt;-</span> <span class="cn">NA_integer_</span>         <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">"strand"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span>                                   <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">strand</span>  <span class="op">&lt;-</span> <span class="cn">NA_character_</span>       <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">"imputed"</span><span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span>                                   <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">imputed</span> <span class="op">&lt;-</span> <span class="cn">NA</span>                  <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">"info"</span>   <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span>                                   <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">info</span>    <span class="op">&lt;-</span> <span class="cn">NA_real_</span>            <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">"q"</span>      <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span>                                   <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">q</span>       <span class="op">&lt;-</span> <span class="cn">NA_real_</span>            <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">"q_p"</span>    <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span>                                   <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">q_p</span>     <span class="op">&lt;-</span> <span class="cn">NA_real_</span>            <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">"i2"</span>     <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span>                                   <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">i2</span>      <span class="op">&lt;-</span> <span class="cn">NA_real_</span>            <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="st">"n"</span>       <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">props</span><span class="op">$</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span>    <span class="op">)</span> <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">n</span>       <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">props</span><span class="op">$</span><span class="va">n</span><span class="op">)</span>     <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="st">"ncase"</span>   <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">props</span><span class="op">$</span><span class="va">ncase</span><span class="op">)</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">ncase</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">props</span><span class="op">$</span><span class="va">ncase</span><span class="op">)</span> <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="st">"strand"</span>  <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">props</span><span class="op">$</span><span class="va">strand</span><span class="op">)</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">strand</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">props</span><span class="op">$</span><span class="va">strand</span><span class="op">)</span><span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">"trait"</span>  <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span>                                   <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">trait</span>   <span class="op">&lt;-</span> <span class="st">"trait"</span><span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">"id"</span>     <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span>                                   <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">id</span>      <span class="op">&lt;-</span> <span class="st">"id"</span> <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">props</span><span class="op">$</span><span class="va">trait</span><span class="op">)</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span>                                <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">trait</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">props</span><span class="op">$</span><span class="va">trait</span><span class="op">)</span> <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">props</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span>                                   <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">id</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">props</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># set filters and qc</span></span>
<span>    <span class="va">props</span><span class="op">$</span><span class="va">qc</span> <span class="op">&lt;-</span> <span class="va">qc</span></span>
<span></span>
<span>    <span class="co"># set correlation matrix if not provided</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">"correlation"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="va">props</span><span class="op">$</span><span class="va">correlation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># set data source</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">is.character</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">props</span><span class="op">$</span><span class="va">source</span> <span class="op">&lt;-</span> <span class="va">dat</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">props</span><span class="op">$</span><span class="va">source</span> <span class="op">&lt;-</span> <span class="st">'data.table'</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># assign to the class object</span></span>
<span>    <span class="va">object</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rconsortium.github.io/S7/reference/new_class.html" class="external-link">new_object</a></span><span class="op">(</span><span class="fu">S7</span><span class="fu">::</span><span class="fu"><a href="https://rconsortium.github.io/S7/reference/S7_object.html" class="external-link">S7_object</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>               map         <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">map</span>,</span>
<span>               qc          <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">qc</span>,</span>
<span>               rsid        <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">rsid</span>,</span>
<span>               chr         <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">chr</span>,</span>
<span>               bp          <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">bp</span>,</span>
<span>               ea          <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">ea</span>,</span>
<span>               oa          <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">oa</span>,</span>
<span>               eaf         <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">eaf</span>,</span>
<span>               beta        <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">beta</span>,</span>
<span>               se          <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">se</span>,</span>
<span>               p           <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">p</span>,</span>
<span>               n           <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">n</span>,</span>
<span>               ncase       <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">ncase</span>,</span>
<span>               strand      <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">strand</span>,</span>
<span>               imputed     <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">imputed</span>,</span>
<span>               info        <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">info</span>,</span>
<span>               q           <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">p</span>,</span>
<span>               q_p         <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">q_p</span>,</span>
<span>               i2          <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">i2</span>,</span>
<span>               trait       <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">trait</span>,</span>
<span>               id          <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">id</span>,</span>
<span>               source      <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">source</span>,</span>
<span>               correlation <span class="op">=</span> <span class="va">props</span><span class="op">$</span><span class="va">correlation</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># return the object</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  <span class="co">#==============================</span></span>
<span>  <span class="co"># GWAS class validator func.</span></span>
<span>  <span class="co">#==============================</span></span>
<span>  validator <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">self</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="st">"Unequal vector lengths"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">rsid</span>, <span class="va">self</span><span class="op">@</span><span class="va">chr</span>, <span class="va">self</span><span class="op">@</span><span class="va">bp</span>, <span class="va">self</span><span class="op">@</span><span class="va">ea</span>, <span class="va">self</span><span class="op">@</span><span class="va">oa</span>, <span class="va">self</span><span class="op">@</span><span class="va">eaf</span>, <span class="va">self</span><span class="op">@</span><span class="va">beta</span>, <span class="va">self</span><span class="op">@</span><span class="va">se</span>, <span class="va">self</span><span class="op">@</span><span class="va">p</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">rsid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="st">"Invalid sample size `n`"</span>       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">n</span><span class="op">)</span><span class="op">&lt;=</span><span class="fl">1</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">n</span><span class="op">)</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">rsid</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="st">"Invalid sample size `ncase`"</span>   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">ncase</span><span class="op">)</span><span class="op">&lt;=</span><span class="fl">1</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">ncase</span><span class="op">)</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">rsid</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="st">"Invalid sample size `strand`"</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">strand</span><span class="op">)</span><span class="op">&lt;=</span><span class="fl">1</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">strand</span><span class="op">)</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">rsid</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="st">"Invalid sample size `imputed`"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">imputed</span><span class="op">)</span><span class="op">&lt;=</span><span class="fl">1</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">imputed</span><span class="op">)</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">rsid</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="st">"Invalid sample size `info`"</span>    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">info</span><span class="op">)</span><span class="op">&lt;=</span><span class="fl">1</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">info</span><span class="op">)</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">rsid</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="st">"Invalid `trait` field length"</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">trait</span><span class="op">)</span><span class="op">&lt;=</span><span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="st">"Invalid `id` field length"</span>     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">self</span><span class="op">@</span><span class="va">id</span><span class="op">)</span><span class="op">&lt;=</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="load-a-gwas">Load a GWAS<a class="anchor" aria-label="anchor" href="#load-a-gwas"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nicksunderland.github.io/genepi.utils/">genepi.utils</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># the datafile </span></span>
<span><span class="va">filepath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"example2_gwas_sumstats.tsv"</span>, package<span class="op">=</span><span class="st">"genepi.utils"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># the column mapping </span></span>
<span><span class="va">columns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'MARKER'</span>, <span class="st">'CHR'</span>, <span class="st">'POS'</span>, <span class="st">'BETA'</span>, <span class="st">'SE'</span>, <span class="st">'P'</span>, <span class="st">'EAF'</span>, <span class="st">'A1'</span>, <span class="st">'A2'</span><span class="op">)</span> <span class="co"># will try to guess standard name mapping</span></span>
<span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ColumnMap.html">ColumnMap</a></span><span class="op">(</span><span class="va">columns</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load</span></span>
<span><span class="va">gwas</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GWAS.html">GWAS</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">filepath</span>, map <span class="op">=</span> <span class="va">map</span>, fill_rsid <span class="op">=</span> <span class="st">"b37_dbsnp156"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading GWAS ...</span></span>
<span><span class="co">#&gt; [i] loading data from: example2_gwas_sumstats.tsv</span></span>
<span><span class="co">#&gt; [i] applying column mapping</span></span>
<span><span class="co">#&gt; [i] enforcing column types</span></span>
<span><span class="co">#&gt; [i] standardising columns</span></span>
<span><span class="co">#&gt; [i] standardising allele coding</span></span>
<span><span class="co">#&gt; [i] applying filters</span></span>
<span><span class="co">#&gt; [i] checking rsid coding</span></span>
<span><span class="co">#&gt;  [?] 10 RSIDs could not be parsed, attempting to fetch from dbSNP.</span></span>
<span><span class="co">#&gt; RSID mapping...</span></span>
<span><span class="co">#&gt; Chromosomes to process:  10</span></span>
<span><span class="co">#&gt; RSID coverage 100% (10/10), of which 0% (0/10) where found flipping alleles</span></span>
<span></span>
<span><span class="co"># view as table</span></span>
<span><span class="fu"><a href="../reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">gwas</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span>
<span><span class="co">#&gt;           rsid    chr        bp     ea     oa      eaf   beta    se     p     n</span></span>
<span><span class="co">#&gt;         &lt;char&gt; &lt;char&gt;     &lt;int&gt; &lt;char&gt; &lt;char&gt;    &lt;num&gt;  &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1:  rs7899632     10 100000625      G      A 7.10e-05 -0.037 0.137 0.781    NA</span></span>
<span><span class="co">#&gt;  2: rs61875309     10 100000645      C      A 1.21e-01  0.045 0.173 0.961    NA</span></span>
<span><span class="co">#&gt;  3: rs12258651     10 100003242      G      T 5.04e-07 -0.037 0.134 0.480    NA</span></span>
<span><span class="co">#&gt;  4:  rs1359508     10 100003785      C      T 1.55e-01 -0.008 0.137 0.743    NA</span></span>
<span><span class="co">#&gt;  5:  rs1048754     10 100004360      A      G 8.38e-01  0.045 0.134 0.961    NA</span></span>
<span><span class="co">#&gt;  6:  rs3750595     10 100004906      A      C 7.40e-01 -0.037 0.173 0.781    NA</span></span>
<span><span class="co">#&gt;  7:  rs2025625     10 100004996      A      G 3.23e-10 -0.008 0.137 0.743    NA</span></span>
<span><span class="co">#&gt;  8: rs10786405     10 100005282      T      C 9.30e-04 -0.147 0.134 0.781    NA</span></span>
<span><span class="co">#&gt;  9: rs11816998     10 100007362      C      G 8.16e-05  0.045 0.173 0.961    NA</span></span>
<span><span class="co">#&gt; 10:  rs3793692     10 100008436      A      G 9.46e-04 -0.008 0.208 0.743    NA</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-an-analysis">Run an analysis<a class="anchor" aria-label="anchor" href="#run-an-analysis"></a>
</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># bmi</span></span>
<span><span class="va">bmi_gwas</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GWAS.html">GWAS</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="st">"/Users/xx20081/Documents/local_data/giant_2018/bmi.giant-ukbb.meta-analysis.combined.23May2018.gz"</span>, </span>
<span>                 map <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>rsid <span class="op">=</span> <span class="st">"SNP"</span>, chr <span class="op">=</span> <span class="st">"CHR"</span>, bp <span class="op">=</span> <span class="st">"POS"</span>, ea <span class="op">=</span> <span class="st">"Tested_Allele"</span>, oa <span class="op">=</span> <span class="st">"Other_Allele"</span>, eaf <span class="op">=</span> <span class="st">"Freq_Tested_Allele"</span>, beta <span class="op">=</span> <span class="st">"BETA"</span>, se <span class="op">=</span> <span class="st">"SE"</span>, p <span class="op">=</span> <span class="st">"P"</span>, n <span class="op">=</span> <span class="st">"N"</span><span class="op">)</span>, </span>
<span>                 trait <span class="op">=</span> <span class="st">"bmi"</span>, </span>
<span>                 id    <span class="op">=</span> <span class="st">"bmi_gwas"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># heart failure</span></span>
<span><span class="va">heart_failure_gwas</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GWAS.html">GWAS</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="st">"/Users/xx20081/Documents/local_data/hermes_incidence/raw/Pheno1_EUR/FORMAT-METAL_Pheno1_EUR.tsv.gz"</span>, </span>
<span>                           map <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>rsid <span class="op">=</span> <span class="st">"rsID"</span>, chr <span class="op">=</span> <span class="st">"chr"</span>, bp <span class="op">=</span> <span class="st">"pos_b37"</span>, ea <span class="op">=</span> <span class="st">"A1"</span>, oa <span class="op">=</span> <span class="st">"A2"</span>, beta <span class="op">=</span> <span class="st">"A1_beta"</span>, eaf <span class="op">=</span> <span class="st">"A1_freq"</span>, se <span class="op">=</span> <span class="st">"se"</span>, p <span class="op">=</span> <span class="st">"pval"</span>, ncase <span class="op">=</span> <span class="st">"N_case"</span>, n <span class="op">=</span> <span class="st">"N_total"</span><span class="op">)</span>, </span>
<span>                           trait <span class="op">=</span> <span class="st">"heart failure"</span>, </span>
<span>                           id    <span class="op">=</span> <span class="st">"hf_gwas"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># coronary artery disease</span></span>
<span><span class="va">cad_gwas</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GWAS.html">GWAS</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="st">"/Users/xx20081/Documents/local_data/cad/GCST90043957_buildGRCh37.tsv.gz"</span>, </span>
<span>                 map <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>rsid <span class="op">=</span> <span class="st">"variant_id"</span>, chr <span class="op">=</span> <span class="st">"chromosome"</span>, bp <span class="op">=</span> <span class="st">"base_pair_location"</span>, ea <span class="op">=</span> <span class="st">"effect_allele"</span>, oa <span class="op">=</span> <span class="st">"other_allele"</span>, beta <span class="op">=</span> <span class="st">"beta"</span>, eaf <span class="op">=</span> <span class="st">"effect_allele_frequency"</span>, se <span class="op">=</span> <span class="st">"standard_error"</span>, p <span class="op">=</span> <span class="st">"p_value"</span>, n <span class="op">=</span> <span class="st">"N"</span><span class="op">)</span>, </span>
<span>                 trait <span class="op">=</span> <span class="st">"coronary artery disease"</span>,</span>
<span>                 id    <span class="op">=</span> <span class="st">"cad_gwas"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create MR object (harmonises)</span></span>
<span><span class="va">mr_object</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MR.html">MR</a></span><span class="op">(</span>exposure <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">bmi_gwas</span>, <span class="va">cad_gwas</span><span class="op">)</span>,</span>
<span>                outcome  <span class="op">=</span> <span class="va">heart_failure_gwas</span>, </span>
<span>                harmonise_strictness <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># clumping</span></span>
<span><span class="va">mr_object</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clump_mr.html">clump_mr</a></span><span class="op">(</span><span class="va">mr_object</span>, p1 <span class="op">=</span> <span class="fl">5e-8</span>, r2 <span class="op">=</span> <span class="fl">0.001</span>, kb <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="mr-object">MR object<a class="anchor" aria-label="anchor" href="#mr-object"></a>
</h2>
<p><img src="figures/mr_class_structure.png" width="100%" style="display: block; margin: auto;"><br></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run mr</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_mr.html">run_mr</a></span><span class="op">(</span><span class="va">mr_object</span>, methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'mr_ivw'</span>,<span class="st">'mr_egger'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot</span></span>
<span><span class="fu"><a href="../reference/plot_mr.html">plot_mr</a></span><span class="op">(</span><span class="va">mr_object</span>, <span class="va">results</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/mr_result_plot_example.png" width="100%" style="display: block; margin: auto;"><br></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/manhattan.html">manhattan</a></span><span class="op">(</span><span class="va">cad_gwas</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/manhattan_cad.png" width="100%" style="display: block; margin: auto;"><br></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/qq_plot.html">qq_plot</a></span><span class="op">(</span><span class="va">cad_gwas</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/qq_cad.png" width="100%" style="display: block; margin: auto;"><br></p>
</div>
<div class="section level2">
<h2 id="other-things">Other things<a class="anchor" aria-label="anchor" href="#other-things"></a>
</h2>
<div class="section level3">
<h3 id="harmonisation">Harmonisation<a class="anchor" aria-label="anchor" href="#harmonisation"></a>
</h3>
<p>Having a highly reusable GWAS object means that it needs to persist
all of the data, as it might subsequently be used for a different
purpose requiring different data. Currently, that means harmonising many
more variants which revealed a bottle-neck in TwoSampleMR::harmonise -
now fixed.</p>
<p>Evaluation speed analysis for harmonisation function. Tests run with
100,000 rows.</p>
<div class="figure" style="text-align: center">
<img src="figures/microbenchmark_harmonise.png" alt="Analysis with downsampled GWAS of 100,000 variants" width="80%"><p class="caption">
Analysis with downsampled GWAS of 100,000 variants
</p>
</div>
<p><br></p>
<div class="figure" style="text-align: center">
<img src="figures/microbenchmark_harmonise_2smr_update.png" alt="Post TwoSampleMR update" width="80%"><p class="caption">
Post TwoSampleMR update
</p>
</div>
</div>
<div class="section level3">
<h3 id="rsid-mapping">RSID mapping<a class="anchor" aria-label="anchor" href="#rsid-mapping"></a>
</h3>
<p>RSID annotation is a common problem. The issue is that dbSNP is huge,
with more than 1 billion variants, so we need a good strategy.
Options:</p>
<ul>
<li>Formal database<br>
</li>
<li>Tabix<br>
</li>
<li>File splitting and parallelization</li>
</ul>
<p>I chose the third option. The principle is outlines below:</p>
<div class="section level4">
<h4 id="which-subsetting-files-method">Which subsetting files method?<a class="anchor" aria-label="anchor" href="#which-subsetting-files-method"></a>
</h4>
<p><code>Fst</code> is the fastest at subsetting files.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">tm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="st">"fst"</span>        <span class="op">=</span> <span class="op">{</span> <span class="va">fst_dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fst_dat</span><span class="op">[</span><span class="st">"p"</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">5e-8</span><span class="op">)</span>, <span class="op">]</span>            <span class="op">}</span>,</span>
<span>                       <span class="st">"data.table"</span> <span class="op">=</span> <span class="op">{</span> <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">fread</span><span class="op">(</span><span class="st">"gwas.tsv.gz"</span><span class="op">)</span>; <span class="va">dat</span><span class="op">[</span><span class="va">p</span> <span class="op">&lt;</span> <span class="fl">5e-8</span>, <span class="op">]</span>     <span class="op">}</span>,</span>
<span>                       <span class="st">"vroom"</span>      <span class="op">=</span> <span class="op">{</span> <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">vroom</span><span class="op">(</span><span class="st">"gwas.tsv.gz"</span><span class="op">)</span>; <span class="va">dat</span><span class="op">[</span><span class="va">dat</span><span class="op">$</span><span class="va">p</span> <span class="op">&lt;</span> <span class="fl">5e-8</span>, <span class="op">]</span> <span class="op">}</span>,</span>
<span>                       times <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html" class="external-link">include_graphics</a></span><span class="op">(</span><span class="st">"figures/subsetting_speed.png"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/subsetting_speed.png" width="50%" style="display: block; margin: auto;"><br></p>
</div>
<div class="section level4">
<h4 id="genepi-utilschrpos_to_rsid">genepi.utils::chrpos_to_rsid<a class="anchor" aria-label="anchor" href="#genepi-utilschrpos_to_rsid"></a>
</h4>
<p><img src="figures/chrpos_to_rsid_diagram.png" width="100%" style="display: block; margin: auto;"><br></p>
</div>
<div class="section level4">
<h4 id="rsid-annotation-for-10m-rows">RSID annotation for 10M rows<a class="anchor" aria-label="anchor" href="#rsid-annotation-for-10m-rows"></a>
</h4>
<p>It’s reasonably fast, for a 10 million row GWAS can process in ~ 4
minutes.</p>
<br><div class="figure" style="text-align: center">
<img src="figures/chrpos_to_rsid_speed.png" alt="Post TwoSampleMR update" width="80%"><p class="caption">
Post TwoSampleMR update
</p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="index-event-bias">Index event bias<a class="anchor" aria-label="anchor" href="#index-event-bias"></a>
</h3>
<p>There are multiple methods to investigate index-event bias. All take
an incidence and progression GWAS plus some initiation parameters. This
function calls grid.expand on the provided parameters and runs all
permeations. The underlying functions are simply those in other packages
as well as functions to run the clumping.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># n.b. function deprecated; now use `collider_bias`</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">analyse_collider_bias</span><span class="op">(</span>gwas_i      <span class="op">=</span> <span class="va">gwas_clumped_incidence</span>,</span>
<span>                                 gwas_p      <span class="op">=</span> <span class="va">gwas_progression</span>,</span>
<span>                                 merge       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CHR"</span><span class="op">=</span><span class="st">"CHR"</span>, <span class="st">"BP"</span><span class="op">=</span><span class="st">"BP"</span><span class="op">)</span>,</span>
<span>                                 methods     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"slopehunter"</span>,<span class="st">"mr_collider_bias"</span>,<span class="st">"dudbridge"</span><span class="op">)</span>,</span>
<span>                                 tsmr_method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mr_ivw"</span>,<span class="st">"mr_egger_regression"</span>,<span class="st">"mr_simple_median"</span>,<span class="st">"mr_simple_mode"</span><span class="op">)</span>,</span>
<span>                                 ip          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="fl">0.001</span>,<span class="fl">0.0001</span>,<span class="fl">0.00001</span>,<span class="fl">0.000001</span>,<span class="fl">0.0000001</span><span class="op">)</span>,</span>
<span>                                 pi0         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span><span class="op">)</span>,</span>
<span>                                 sxy1        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-05</span><span class="op">)</span>,</span>
<span>                                 bootstraps  <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot</span></span>
<span><span class="fu">plot_slope</span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="fu">plot_correction_stability</span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/collider_slopes.png" width="98%" style="display: block; margin: auto;"><br></p>
<p><img src="figures/collider_stability.png" width="75%" style="display: block; margin: auto;"><br></p>
</div>
</div>
<div class="section level2">
<h2 id="other-packages">Other packages<a class="anchor" aria-label="anchor" href="#other-packages"></a>
</h2>
<div class="section level3">
<h3 id="mungesumstats">MungeSumstats<a class="anchor" aria-label="anchor" href="#mungesumstats"></a>
</h3>
<p><code>MungeSumstats</code> is quite a comprehensive GWAS formatting
package with many control options. It uses the
<code>SNPlocs.Hsapiens</code> Bioconductor packages for RSID mapping.
Unfortunately the <code>SNPlocs</code> packages are routinely updated
with the latest dbSNP releases and do no include all of the indels
present in dbSNP which can be limiting if you are interested in indels.
The microbenchmarking below is slightly unfair as
<code>MungeSumstats</code> does more checks.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/neurogenomics/MungeSumstats" class="external-link">MungeSumstats</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">hf_gwas_file</span> <span class="op">&lt;-</span> <span class="st">"/Users/xx20081/Documents/local_data/hermes_incidence/raw/Pheno1_EUR/FORMAT-METAL_Pheno1_EUR.tsv.gz"</span></span>
<span><span class="va">hf_gwas_map</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>rsid <span class="op">=</span> <span class="st">"rsID"</span>, chr <span class="op">=</span> <span class="st">"chr"</span>, bp <span class="op">=</span> <span class="st">"pos_b37"</span>, ea <span class="op">=</span> <span class="st">"A1"</span>, oa <span class="op">=</span> <span class="st">"A2"</span>, beta <span class="op">=</span> <span class="st">"A1_beta"</span>, eaf <span class="op">=</span> <span class="st">"A1_freq"</span>, se <span class="op">=</span> <span class="st">"se"</span>, p <span class="op">=</span> <span class="st">"pval"</span>, ncase <span class="op">=</span> <span class="st">"N_case"</span>, n <span class="op">=</span> <span class="st">"N_total"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="st">"MungeSumstats"</span> <span class="op">=</span> <span class="op">{</span><span class="fu">MungeSumstats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MungeSumstats/man/format_sumstats.html" class="external-link">format_sumstats</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">hf_gwas_file</span>,</span>
<span>                                                                       ref_genome <span class="op">=</span> <span class="st">"GRCh37"</span>, </span>
<span>                                                                       return_data <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                                                                       nThread <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">}</span>,</span>
<span>                     <span class="st">"genepi.utils"</span> <span class="op">=</span> <span class="op">{</span><span class="fu">genepi.utils</span><span class="fu">::</span><span class="fu"><a href="../reference/GWAS.html">GWAS</a></span><span class="op">(</span>dat       <span class="op">=</span> <span class="va">hf_gwas_file</span>, </span>
<span>                                                          map       <span class="op">=</span> <span class="va">hf_gwas_map</span>, </span>
<span>                                                          fill_rsid <span class="op">=</span> <span class="st">"b37_dbsnp156"</span>,</span>
<span>                                                          trait     <span class="op">=</span> <span class="st">"heart failure"</span>, </span>
<span>                                                          id        <span class="op">=</span> <span class="st">"hf_gwas"</span><span class="op">)</span><span class="op">}</span>, </span>
<span>                     times <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">tm</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/mungesumstats_speed.png" width="100%" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="future-directions">Future directions<a class="anchor" aria-label="anchor" href="#future-directions"></a>
</h2>
<ul>
<li>Focus on actually delivering my PhD proposal<br>
</li>
<li>Thought about using <code>.fst</code> files to persist data behind a
GWAS object, so that all of the data doesn’t need to sit in memory and
you just store index information into the file.<br>
</li>
<li>Reading of a GWAS looks in cache for previous cleaned file and loads
that, add a <code>reload_raw = TRUE/FALSE</code> option.</li>
</ul>
</div>
<div class="section level2">
<h2 id="discussion">Discussion<a class="anchor" aria-label="anchor" href="#discussion"></a>
</h2>
<ul>
<li>Is a unified approach to handling GWAS data in R needed?<br>
</li>
<li>If so, who should attempt it?<br>
</li>
<li>If so, how should it be done? (levels of abstraction)</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Nicholas Sunderland.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
